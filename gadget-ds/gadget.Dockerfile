# Builder: traceloop

FROM docker.io/kinvolk/traceloop:alban-pidns as traceloop

# Builder: bpftool

FROM docker.io/kinvolk/bpftool:20191122204402789b1a as bpftool-build

# Builder: cgroupid

FROM kinvolk/cgroupid as cgroupid

# Main gadget image

FROM docker.io/kinvolk/bcc:latest
RUN apt-get update && apt-get install -y --no-install-recommends \
	ca-certificates curl && \
	curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl && \
	chmod +x kubectl && \
	mv kubectl /bin/

COPY files/runc-hook-prestart.sh /bin/runc-hook-prestart.sh
COPY files/runc-hook-prestart-create-maps.sh /bin/runc-hook-prestart-create-maps.sh
COPY files/gadget-node-install.sh /bin/gadget-node-install.sh
COPY files/gadget-node-health-check.sh /bin/gadget-node-health-check.sh
COPY files/bcck8s /opt/bcck8s

COPY --from=bpftool-build /bin/bpftool /bin/bpftool
COPY --from=traceloop /bin/traceloop /bin/traceloop
COPY --from=cgroupid /bin/cgroupid /bin/cgroupid

